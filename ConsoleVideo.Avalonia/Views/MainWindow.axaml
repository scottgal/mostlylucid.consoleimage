<wnd:AppWindow xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:ConsoleVideo.Avalonia.ViewModels"
        xmlns:controls="using:ConsoleVideo.Avalonia.Controls"
        xmlns:ui="using:FluentAvalonia.UI.Controls"
        xmlns:wnd="using:FluentAvalonia.UI.Windowing"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d" d:DesignWidth="1400" d:DesignHeight="900"
        x:Class="ConsoleVideo.Avalonia.Views.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        Title="ConsoleVideo"
        Width="1400" Height="900"
        MinWidth="1000" MinHeight="700"
        WindowStartupLocation="CenterScreen"
        DragDrop.AllowDrop="True"
        KeyDown="Window_KeyDown">

    <Window.Styles>
        <Style Selector="Border.panel">
            <Setter Property="Background" Value="{DynamicResource CardBackgroundFillColorDefaultBrush}"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="12"/>
            <Setter Property="BorderBrush" Value="{DynamicResource CardStrokeColorDefaultBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
        </Style>
        <Style Selector="TextBlock.section-header">
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="Foreground" Value="{DynamicResource TextFillColorPrimaryBrush}"/>
            <Setter Property="Margin" Value="0,0,0,8"/>
        </Style>
        <Style Selector="TextBlock.label">
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="Foreground" Value="{DynamicResource TextFillColorSecondaryBrush}"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
    </Window.Styles>

    <Grid RowDefinitions="Auto,*,Auto,Auto">
        <!-- Menu Bar -->
        <Menu Grid.Row="0">
            <MenuItem Header="_File">
                <MenuItem Header="_Open Video..." Click="OpenVideo_Click" InputGesture="Ctrl+O">
                    <MenuItem.Icon>
                        <ui:SymbolIcon Symbol="OpenFolder"/>
                    </MenuItem.Icon>
                </MenuItem>
                <Separator/>
                <MenuItem Header="_Save Keyframes..." Click="SaveKeyframes_Click" IsEnabled="{Binding Keyframes.Count}">
                    <MenuItem.Icon>
                        <ui:SymbolIcon Symbol="Save"/>
                    </MenuItem.Icon>
                </MenuItem>
                <MenuItem Header="Export _Manifest..." Click="ExportManifest_Click" IsEnabled="{Binding Keyframes.Count}">
                    <MenuItem.Icon>
                        <ui:SymbolIcon Symbol="Document"/>
                    </MenuItem.Icon>
                </MenuItem>
                <Separator/>
                <MenuItem Header="E_xit" Click="Exit_Click"/>
            </MenuItem>
            <MenuItem Header="_View">
                <MenuItem Header="_Extract Keyframes" Command="{Binding ExtractKeyframesCommand}">
                    <MenuItem.Icon>
                        <ui:SymbolIcon Symbol="Pictures"/>
                    </MenuItem.Icon>
                </MenuItem>
                <Separator/>
                <MenuItem Header="_Fullscreen" Click="ToggleFullscreen_Click" InputGesture="F11">
                    <MenuItem.Icon>
                        <ui:SymbolIcon Symbol="FullScreenMaximize"/>
                    </MenuItem.Icon>
                </MenuItem>
                <Separator/>
                <MenuItem Header="Window _Size">
                    <MenuItem Header="Small (1000x700)" Click="SetWindowSize_Click" Tag="1000,700"/>
                    <MenuItem Header="Medium (1400x900)" Click="SetWindowSize_Click" Tag="1400,900"/>
                    <MenuItem Header="Large (1800x1000)" Click="SetWindowSize_Click" Tag="1800,1000"/>
                    <MenuItem Header="Extra Large (2200x1200)" Click="SetWindowSize_Click" Tag="2200,1200"/>
                    <Separator/>
                    <MenuItem Header="_Maximize" Click="Maximize_Click"/>
                </MenuItem>
                <Separator/>
                <MenuItem Header="_Theme">
                    <MenuItem Header="_Dark" Click="SetTheme_Click" Tag="Dark"/>
                    <MenuItem Header="_Light" Click="SetTheme_Click" Tag="Light"/>
                </MenuItem>
            </MenuItem>
            <MenuItem Header="_Help">
                <MenuItem Header="_About" Click="About_Click">
                    <MenuItem.Icon>
                        <ui:SymbolIcon Symbol="Help"/>
                    </MenuItem.Icon>
                </MenuItem>
            </MenuItem>
        </Menu>

        <!-- Main Content: Split View -->
        <Grid Grid.Row="1" ColumnDefinitions="*,*,260" Margin="12,8,12,8">

            <!-- Left Panel: Original Video Preview -->
            <Border Grid.Column="0" Classes="panel" Margin="0,0,6,0">
                <Grid RowDefinitions="Auto,*,Auto">
                    <TextBlock Classes="section-header" Text="Original Video"/>

                    <Border Grid.Row="1" Background="#0D0D0D" CornerRadius="6"
                            Cursor="{Binding HasVideo, Converter={x:Static vm:EnumConverters.HasVideoToCursor}}"
                            PointerPressed="VideoPreview_PointerPressed">
                        <Grid>
                            <Image Source="{Binding CurrentFrame}"
                                   Stretch="Uniform"
                                   HorizontalAlignment="Center"
                                   VerticalAlignment="Center"/>

                            <!-- Drop hint overlay - clickable -->
                            <Border Background="#60000000"
                                    VerticalAlignment="Center" HorizontalAlignment="Center"
                                    CornerRadius="8" Padding="20,12"
                                    IsVisible="{Binding !HasVideo}">
                                <StackPanel Spacing="8" HorizontalAlignment="Center">
                                    <ui:SymbolIcon Symbol="Video" FontSize="32"/>
                                    <TextBlock Text="Click here or drop media to open"
                                               Foreground="White" FontSize="13"/>
                                </StackPanel>
                            </Border>
                        </Grid>
                    </Border>

                    <!-- Timeline controls -->
                    <StackPanel Grid.Row="2" Margin="0,10,0,0" Spacing="6">
                        <!-- Visual thumbnail scrub bar -->
                        <Border Background="#1A1A1A" CornerRadius="4" Padding="2" Height="36"
                                IsVisible="{Binding HasVideo}">
                            <Grid>
                                <!-- Loading indicator -->
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Center"
                                            IsVisible="{Binding IsLoadingTimeline}" Spacing="8">
                                    <TextBlock Classes="label" Text="Loading timeline..."/>
                                    <TextBlock Classes="label" Text="{Binding TimelineProgress, StringFormat='{}{0:P0}'}"/>
                                </StackPanel>

                                <!-- Thumbnail strip - ItemsControl with horizontal stack -->
                                <ItemsControl ItemsSource="{Binding TimelineThumbnails}" IsVisible="{Binding !IsLoadingTimeline}">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <StackPanel Orientation="Horizontal" Spacing="1"/>
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Button Padding="0" Background="Transparent" BorderThickness="0"
                                                    ToolTip.Tip="{Binding TimestampFormatted}"
                                                    Click="TimelineThumbnail_Click">
                                                <Image Source="{Binding Thumbnail}"
                                                       Width="32" Height="32"
                                                       Stretch="UniformToFill"/>
                                            </Button>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </Grid>
                        </Border>

                        <Slider Minimum="0"
                                Maximum="{Binding Duration}"
                                Value="{Binding CurrentPosition}"
                                IsEnabled="{Binding HasVideo}"/>
                        <Grid ColumnDefinitions="Auto,*,Auto">
                            <TextBlock Classes="label" Text="{Binding CurrentPosition, StringFormat='{}{0:F1}s'}"/>
                            <TextBlock Grid.Column="2" Classes="label" Text="{Binding Duration, StringFormat='{}{0:F1}s'}"/>
                        </Grid>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- Center Panel: ASCII Preview -->
            <Border Grid.Column="1" Classes="panel" Margin="6,0,6,0">
                <Grid RowDefinitions="Auto,*,Auto">
                    <Grid ColumnDefinitions="*,Auto">
                        <TextBlock Classes="section-header" Text="ASCII Preview"/>
                        <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8">
                            <TextBlock Classes="label"
                                       Text="{Binding SelectedKeyframe.TimestampFormatted, FallbackValue=''}"
                                       FontFamily="Cascadia Mono, Consolas, monospace"/>
                            <Border Background="{DynamicResource SystemFillColorSuccessBackgroundBrush}"
                                    CornerRadius="4" Padding="6,2"
                                    IsVisible="{Binding SelectedKeyframe.IsSceneBoundary, FallbackValue=False}">
                                <TextBlock Text="Scene" FontSize="10" Foreground="White"/>
                            </Border>
                        </StackPanel>
                    </Grid>

                    <Border Grid.Row="1" Background="#0C0C0C" CornerRadius="6" ClipToBounds="True">
                        <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto">
                            <controls:AnsiTextBlock AnsiText="{Binding AsciiPreview}"
                                                    FontSize="9"
                                                    Margin="6"/>
                        </ScrollViewer>
                    </Border>

                    <!-- Playback Controls -->
                    <StackPanel Grid.Row="2" Orientation="Horizontal" Spacing="4" Margin="0,10,0,0"
                                HorizontalAlignment="Center">
                        <Button Command="{Binding PreviousKeyframeCommand}"
                                IsEnabled="{Binding Keyframes.Count}" ToolTip.Tip="Previous frame"
                                Padding="10,8">
                            <ui:SymbolIcon Symbol="Previous" FontSize="16"/>
                        </Button>
                        <Button Command="{Binding TogglePlaybackCommand}"
                                IsEnabled="{Binding Keyframes.Count}" ToolTip.Tip="Play/Pause"
                                Padding="12,8">
                            <Panel>
                                <ui:SymbolIcon Symbol="Pause" FontSize="18" IsVisible="{Binding IsPlaying}"/>
                                <ui:SymbolIcon Symbol="Play" FontSize="18" IsVisible="{Binding !IsPlaying}"/>
                            </Panel>
                        </Button>
                        <Button Command="{Binding NextKeyframeCommand}"
                                IsEnabled="{Binding Keyframes.Count}" ToolTip.Tip="Next frame"
                                Padding="10,8">
                            <ui:SymbolIcon Symbol="Next" FontSize="16"/>
                        </Button>
                        <TextBlock Classes="label" Margin="12,0,0,0"
                                   Text="{Binding CurrentKeyframeIndex, StringFormat='Frame {0}'}"/>
                        <TextBlock Classes="label" Text="{Binding Keyframes.Count, StringFormat='/ {0}'}"/>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- Right Panel: Settings -->
            <Border Grid.Column="2" Classes="panel" Margin="6,0,0,0">
                <ScrollViewer>
                    <StackPanel Spacing="10">
                        <!-- Main Action -->
                        <Button Command="{Binding ExtractKeyframesCommand}"
                                IsEnabled="{Binding HasVideo}"
                                HorizontalAlignment="Stretch"
                                HorizontalContentAlignment="Center"
                                Padding="12,12"
                                Classes="accent">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <ui:SymbolIcon Symbol="Pictures" FontSize="16"/>
                                <TextBlock Text="Extract Keyframes" FontWeight="SemiBold"/>
                            </StackPanel>
                        </Button>

                        <!-- Progress -->
                        <ProgressBar Value="{Binding Progress}"
                                     Maximum="1"
                                     IsVisible="{Binding IsLoading}"
                                     Height="3"/>

                        <!-- Count Display -->
                        <TextBlock Text="{Binding CountDisplay}"
                                   IsVisible="{Binding ExtractedCount}"
                                   TextAlignment="Center" FontSize="11"
                                   Foreground="{DynamicResource TextFillColorSecondaryBrush}"/>

                        <Separator Margin="0,4"/>

                        <!-- Settings Grid -->
                        <Grid ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto,Auto,Auto" Margin="0,4">
                            <TextBlock Classes="label" Text="Frames"/>
                            <NumericUpDown Grid.Column="1" Value="{Binding TargetKeyframeCount}"
                                           Minimum="1" Maximum="100" Width="90"
                                           HorizontalAlignment="Right"/>

                            <TextBlock Grid.Row="1" Classes="label" Text="Strategy" Margin="0,8,0,0"/>
                            <ComboBox Grid.Row="1" Grid.Column="1" SelectedIndex="{Binding SelectedStrategy}"
                                      HorizontalAlignment="Right" Width="110" Margin="0,8,0,0">
                                <ComboBoxItem Content="Uniform"/>
                                <ComboBoxItem Content="I-Frames"/>
                                <ComboBoxItem Content="Scene"/>
                                <ComboBoxItem Content="Adaptive"/>
                            </ComboBox>

                            <TextBlock Grid.Row="2" Classes="label" Text="Start" Margin="0,8,0,0"/>
                            <NumericUpDown Grid.Row="2" Grid.Column="1" Value="{Binding RangeStart}"
                                           Minimum="0" Maximum="{Binding Duration}"
                                           FormatString="F1" Increment="1" Width="90"
                                           HorizontalAlignment="Right" Margin="0,8,0,0"/>

                            <TextBlock Grid.Row="3" Classes="label" Text="End" Margin="0,8,0,0"/>
                            <NumericUpDown Grid.Row="3" Grid.Column="1" Value="{Binding RangeEnd}"
                                           Minimum="0" Maximum="{Binding Duration}"
                                           FormatString="F1" Increment="1" Width="90"
                                           HorizontalAlignment="Right" Margin="0,8,0,0"/>
                        </Grid>

                        <Separator Margin="0,4"/>

                        <!-- Render Mode -->
                        <TextBlock Classes="label" Text="Render Mode"/>
                        <StackPanel Orientation="Horizontal" Spacing="4" Margin="0,4,0,0">
                            <RadioButton Content="ASCII" GroupName="RenderMode" Padding="8,6"
                                         IsChecked="{Binding SelectedRenderMode, Converter={x:Static vm:EnumConverters.RenderModeAscii}}"/>
                            <RadioButton Content="Blocks" GroupName="RenderMode" Padding="8,6"
                                         IsChecked="{Binding SelectedRenderMode, Converter={x:Static vm:EnumConverters.RenderModeBlocks}}"/>
                            <RadioButton Content="Braille" GroupName="RenderMode" Padding="8,6"
                                         IsChecked="{Binding SelectedRenderMode, Converter={x:Static vm:EnumConverters.RenderModeBraille}}"/>
                        </StackPanel>

                        <Separator Margin="0,4"/>

                        <!-- Terminal Preview -->
                        <Button Click="PreviewInTerminal_Click"
                                IsEnabled="{Binding HasVideo}"
                                HorizontalAlignment="Stretch"
                                HorizontalContentAlignment="Center"
                                Padding="10,8">
                            <StackPanel Orientation="Horizontal" Spacing="6">
                                <TextBlock Text="⌘" FontSize="14" VerticalAlignment="Center"/>
                                <TextBlock Text="Open in Terminal"/>
                            </StackPanel>
                        </Button>

                        <!-- Transcription -->
                        <Button Click="TranscribeSpeech_Click"
                                IsEnabled="{Binding HasVideo}"
                                HorizontalAlignment="Stretch"
                                HorizontalContentAlignment="Center"
                                Padding="10,8"
                                Margin="0,4,0,0">
                            <StackPanel Orientation="Horizontal" Spacing="6">
                                <ui:SymbolIcon Symbol="Microphone" FontSize="14"/>
                                <TextBlock Text="Transcribe Speech"/>
                            </StackPanel>
                        </Button>

                        <!-- Advanced Options -->
                        <Expander Header="Advanced" Margin="0,6,0,0" Padding="0">
                            <StackPanel Spacing="10" Margin="0,10,0,0">
                                <Grid ColumnDefinitions="Auto,*">
                                    <TextBlock Classes="label" Text="{Binding PreviewWidth, StringFormat='Width {0}'}" Width="55"/>
                                    <Slider Grid.Column="1" Minimum="40" Maximum="120"
                                            Value="{Binding PreviewWidth}"/>
                                </Grid>

                                <Grid ColumnDefinitions="Auto,*">
                                    <TextBlock Classes="label" Text="{Binding SceneThreshold, StringFormat='Scene {0:F2}'}" Width="55"/>
                                    <Slider Grid.Column="1" Minimum="0.1" Maximum="0.9"
                                            Value="{Binding SceneThreshold}"/>
                                </Grid>

                                <Grid ColumnDefinitions="Auto,*">
                                    <TextBlock Classes="label" Text="{Binding GifDuration, StringFormat='GIF {0:F0}s'}" Width="55"/>
                                    <Slider Grid.Column="1" Minimum="1" Maximum="30"
                                            Value="{Binding GifDuration}"/>
                                </Grid>

                                <Grid ColumnDefinitions="Auto,*">
                                    <TextBlock Classes="label" Text="{Binding PlaybackSpeed, StringFormat='Speed {0:F1}x'}" Width="55"/>
                                    <Slider Grid.Column="1" Minimum="0.5" Maximum="5"
                                            Value="{Binding PlaybackSpeed}"/>
                                </Grid>
                            </StackPanel>
                        </Expander>
                    </StackPanel>
                </ScrollViewer>
            </Border>
        </Grid>

        <!-- Keyframe Filmstrip -->
        <Border Grid.Row="2" Classes="panel" Margin="12,0,12,8" Padding="12,8">
            <Grid RowDefinitions="Auto,*">
                <Grid ColumnDefinitions="Auto,*,Auto" Margin="0,0,0,6">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <ui:SymbolIcon Symbol="Pictures" FontSize="14"/>
                        <TextBlock Classes="section-header" Text="Keyframes" Margin="0"/>
                    </StackPanel>
                    <TextBlock Grid.Column="2" Classes="label"
                               Text="{Binding SelectedKeyframe.Source, FallbackValue=''}"/>
                </Grid>

                <ScrollViewer Grid.Row="1" HorizontalScrollBarVisibility="Auto"
                              VerticalScrollBarVisibility="Disabled" Height="110">
                    <ItemsControl ItemsSource="{Binding Keyframes}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <StackPanel Orientation="Horizontal" Spacing="8"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate x:DataType="vm:KeyframeViewModel">
                                <Border Background="{DynamicResource CardBackgroundFillColorSecondaryBrush}"
                                        BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                                        BorderThickness="1"
                                        CornerRadius="6" Padding="4"
                                        Cursor="Hand"
                                        PointerPressed="Keyframe_PointerPressed">
                                    <StackPanel Width="90">
                                        <Grid>
                                            <Image Source="{Binding Thumbnail}"
                                                   Width="90" Height="60"
                                                   Stretch="Uniform"/>
                                            <!-- Scene boundary indicator -->
                                            <Border Background="#CC00AA00" CornerRadius="3"
                                                    Padding="4,2" Margin="2"
                                                    HorizontalAlignment="Left" VerticalAlignment="Top"
                                                    IsVisible="{Binding IsSceneBoundary}">
                                                <TextBlock Text="Scene" FontSize="8" Foreground="White" FontWeight="SemiBold"/>
                                            </Border>
                                        </Grid>
                                        <TextBlock Text="{Binding TimestampFormatted}"
                                                   HorizontalAlignment="Center"
                                                   FontSize="10" Margin="0,4,0,0"
                                                   FontFamily="Cascadia Mono, Consolas, monospace"/>
                                        <TextBlock Text="{Binding Index, StringFormat='#{0}'}"
                                                   HorizontalAlignment="Center"
                                                   FontSize="9"
                                                   Foreground="{DynamicResource TextFillColorTertiaryBrush}"/>
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>

                <StackPanel Grid.Row="1"
                           IsVisible="{Binding !Keyframes.Count}"
                           VerticalAlignment="Center"
                           HorizontalAlignment="Center"
                           Spacing="8">
                    <ui:SymbolIcon Symbol="Pictures" FontSize="24" Foreground="{DynamicResource TextFillColorTertiaryBrush}"/>
                    <TextBlock Text="Extract keyframes to see them here"
                               Foreground="{DynamicResource TextFillColorTertiaryBrush}"
                               FontSize="12"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Status Bar -->
        <Border Grid.Row="3" Background="{DynamicResource CardBackgroundFillColorSecondaryBrush}"
                Padding="16,8">
            <Grid ColumnDefinitions="*,Auto">
                <TextBlock Text="{Binding StatusText}" VerticalAlignment="Center" FontSize="12"/>
                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="16"
                            IsVisible="{Binding HasVideo}">
                    <TextBlock Classes="label" Text="{Binding VideoInfo.Width, StringFormat='{}{0}×'}"/>
                    <TextBlock Classes="label" Text="{Binding VideoInfo.Height}"/>
                    <TextBlock Classes="label" Text="{Binding VideoInfo.FrameRate, StringFormat='{}{0:F1} fps'}"/>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</wnd:AppWindow>
