name: Publish All NuGet Packages

# This workflow publishes ALL NuGet packages AND CLI releases:
# 0. ConsoleImage.Player (zero deps) → wait for NuGet availability
# 1. ConsoleImage.Core (needs Player) → wait for NuGet availability
# 2. ConsoleImage.Video.Core (needs Core) ─┬─ run in parallel after Core is available
# 3. ConsoleImage.Spectre (needs Core)    ─┘
# 4. Build & release CLI binaries (consoleimage, consoleimage-mcp)

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version for ALL packages (e.g., 2.5.1)'
        required: true

permissions:
  id-token: write
  contents: write
  packages: write

env:
  DOTNET_VERSION: '10.0.x'

jobs:
  # ============================================
  # STEP 0: Publish Player package (zero deps, must go first  -  Core depends on it)
  # ============================================
  publish-player:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ github.event.inputs.version }}
    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - uses: actions/setup-dotnet@v5
      with:
        dotnet-version: '10.0.x'

    - name: Create version tag for MinVer
      run: |
        TAG="consoleimage-player-v${{ github.event.inputs.version }}"
        if git rev-parse "$TAG" >/dev/null 2>&1; then
          echo "Tag $TAG already exists, skipping creation"
        else
          git tag "$TAG"
          echo "Created tag $TAG"
        fi

    - name: Build & Pack Player
      run: |
        dotnet restore ConsoleImage.Player/ConsoleImage.Player.csproj
        dotnet pack ConsoleImage.Player/ConsoleImage.Player.csproj -c Release -o ./artifacts

    - name: NuGet Login (OIDC)
      id: nuget
      uses: NuGet/login@v1
      with:
        user: 'mostlylucid'

    - name: Publish Player to NuGet.org
      run: dotnet nuget push ./artifacts/*.nupkg --api-key ${{ steps.nuget.outputs.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate

    - name: Publish Player to GitHub Packages
      run: dotnet nuget push ./artifacts/*.nupkg --api-key ${{ secrets.GITHUB_TOKEN }} --source https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json --skip-duplicate

  # ============================================
  # Wait for Player to be available on NuGet
  # ============================================
  wait-for-player:
    runs-on: ubuntu-latest
    needs: publish-player
    steps:
    - name: Wait for Player package availability on NuGet
      run: |
        VERSION="${{ needs.publish-player.outputs.version }}"
        echo "Waiting for mostlylucid.consoleimage.player version ${VERSION} to be available on NuGet..."

        MAX_ATTEMPTS=60
        ATTEMPT=0

        while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
          ATTEMPT=$((ATTEMPT + 1))
          echo "Attempt ${ATTEMPT}/${MAX_ATTEMPTS}: Checking NuGet API..."

          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            "https://api.nuget.org/v3-flatcontainer/mostlylucid.consoleimage.player/${VERSION}/mostlylucid.consoleimage.player.${VERSION}.nupkg")

          if [ "$HTTP_STATUS" = "200" ]; then
            echo "Package mostlylucid.consoleimage.player ${VERSION} is available!"
            exit 0
          fi

          echo "Package not yet available (HTTP ${HTTP_STATUS}), waiting 30 seconds..."
          sleep 30
        done

        echo "ERROR: Timeout waiting for package availability on NuGet."
        exit 1

  # ============================================
  # STEP 1: Publish Core package (depends on Player)
  # ============================================
  publish-core:
    runs-on: ubuntu-latest
    needs: [publish-player, wait-for-player]
    outputs:
      version: ${{ github.event.inputs.version }}
    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - uses: actions/setup-dotnet@v5
      with:
        dotnet-version: '10.0.x'

    - name: Create version tag for MinVer
      run: |
        TAG="consoleimage-v${{ github.event.inputs.version }}"
        if git rev-parse "$TAG" >/dev/null 2>&1; then
          echo "Tag $TAG already exists, skipping creation"
        else
          git tag "$TAG"
          echo "Created tag $TAG"
        fi

    - name: Build & Pack Core
      run: |
        dotnet restore ConsoleImage.Core/ConsoleImage.Core.csproj \
          -p:UseNuGetDependency=true \
          -p:PlayerPackageVersion=${{ needs.publish-player.outputs.version }}
        dotnet pack ConsoleImage.Core/ConsoleImage.Core.csproj \
          -c Release \
          -o ./artifacts \
          -p:UseNuGetDependency=true \
          -p:PlayerPackageVersion=${{ needs.publish-player.outputs.version }}

    - name: NuGet Login (OIDC)
      id: nuget
      uses: NuGet/login@v1
      with:
        user: 'mostlylucid'

    - name: Publish Core to NuGet.org
      run: dotnet nuget push ./artifacts/*.nupkg --api-key ${{ steps.nuget.outputs.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate

    - name: Publish Core to GitHub Packages
      run: dotnet nuget push ./artifacts/*.nupkg --api-key ${{ secrets.GITHUB_TOKEN }} --source https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json --skip-duplicate

  # ============================================
  # Wait for Core to be available on NuGet
  # ============================================
  wait-for-core:
    runs-on: ubuntu-latest
    needs: publish-core
    steps:
    - name: Wait for Core package availability on NuGet
      run: |
        VERSION="${{ needs.publish-core.outputs.version }}"
        echo "Waiting for mostlylucid.consoleimage version ${VERSION} to be available on NuGet..."

        MAX_ATTEMPTS=60
        ATTEMPT=0

        while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
          ATTEMPT=$((ATTEMPT + 1))
          echo "Attempt ${ATTEMPT}/${MAX_ATTEMPTS}: Checking NuGet API..."

          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            "https://api.nuget.org/v3-flatcontainer/mostlylucid.consoleimage/${VERSION}/mostlylucid.consoleimage.${VERSION}.nupkg")

          if [ "$HTTP_STATUS" = "200" ]; then
            echo "Package mostlylucid.consoleimage ${VERSION} is available!"
            exit 0
          fi

          echo "Package not yet available (HTTP ${HTTP_STATUS}), waiting 30 seconds..."
          sleep 30
        done

        echo "ERROR: Timeout waiting for package availability on NuGet."
        exit 1

  # ============================================
  # STEP 2: Publish Video (depends on Core)
  # ============================================
  publish-video:
    runs-on: ubuntu-latest
    needs: [publish-core, wait-for-core]
    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - uses: actions/setup-dotnet@v5
      with:
        dotnet-version: '10.0.x'

    - name: Create version tag for MinVer
      run: |
        TAG="consoleimage-video-v${{ needs.publish-core.outputs.version }}"
        if git rev-parse "$TAG" >/dev/null 2>&1; then
          echo "Tag $TAG already exists, skipping creation"
        else
          git tag "$TAG"
          echo "Created tag $TAG"
        fi

    - name: Build & Pack Video.Core
      run: |
        dotnet restore ConsoleImage.Video.Core/ConsoleImage.Video.Core.csproj \
          -p:UseNuGetDependency=true \
          -p:CorePackageVersion=${{ needs.publish-core.outputs.version }}
        dotnet pack ConsoleImage.Video.Core/ConsoleImage.Video.Core.csproj \
          -c Release \
          -o ./artifacts \
          -p:UseNuGetDependency=true \
          -p:CorePackageVersion=${{ needs.publish-core.outputs.version }}

    - name: NuGet Login (OIDC)
      id: nuget
      uses: NuGet/login@v1
      with:
        user: 'mostlylucid'

    - name: Publish Video.Core to NuGet.org
      run: dotnet nuget push ./artifacts/*.nupkg --api-key ${{ steps.nuget.outputs.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate

    - name: Publish Video.Core to GitHub Packages
      run: dotnet nuget push ./artifacts/*.nupkg --api-key ${{ secrets.GITHUB_TOKEN }} --source https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json --skip-duplicate

  # ============================================
  # STEP 3: Publish Transcription (depends on Core, parallel with Video/Spectre)
  # ============================================
  publish-transcription:
    runs-on: ubuntu-latest
    needs: [publish-core, wait-for-core]
    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - uses: actions/setup-dotnet@v5
      with:
        dotnet-version: '10.0.x'

    - name: Create version tag for MinVer
      run: |
        TAG="consoleimage-transcription-v${{ needs.publish-core.outputs.version }}"
        if git rev-parse "$TAG" >/dev/null 2>&1; then
          echo "Tag $TAG already exists, skipping creation"
        else
          git tag "$TAG"
          echo "Created tag $TAG"
        fi

    - name: Build & Pack Transcription
      run: |
        dotnet restore ConsoleImage.Transcription/ConsoleImage.Transcription.csproj \
          -p:UseNuGetDependency=true \
          -p:CorePackageVersion=${{ needs.publish-core.outputs.version }}
        dotnet pack ConsoleImage.Transcription/ConsoleImage.Transcription.csproj \
          -c Release \
          -o ./artifacts \
          -p:UseNuGetDependency=true \
          -p:CorePackageVersion=${{ needs.publish-core.outputs.version }}

    - name: NuGet Login (OIDC)
      id: nuget
      uses: NuGet/login@v1
      with:
        user: 'mostlylucid'

    - name: Publish Transcription to NuGet.org
      run: dotnet nuget push ./artifacts/*.nupkg --api-key ${{ steps.nuget.outputs.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate

    - name: Publish Transcription to GitHub Packages
      run: dotnet nuget push ./artifacts/*.nupkg --api-key ${{ secrets.GITHUB_TOKEN }} --source https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json --skip-duplicate

  # ============================================
  # STEP 3b: Publish Spectre (depends on Core, parallel with Video/Transcription)
  # ============================================
  publish-spectre:
    runs-on: ubuntu-latest
    needs: [publish-core, wait-for-core]
    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - uses: actions/setup-dotnet@v5
      with:
        dotnet-version: '10.0.x'

    - name: Create version tag for MinVer
      run: |
        TAG="consoleimage-spectre-v${{ needs.publish-core.outputs.version }}"
        if git rev-parse "$TAG" >/dev/null 2>&1; then
          echo "Tag $TAG already exists, skipping creation"
        else
          git tag "$TAG"
          echo "Created tag $TAG"
        fi

    - name: Build & Pack Spectre
      run: |
        dotnet restore ConsoleImage.Spectre/ConsoleImage.Spectre.csproj \
          -p:UseNuGetDependency=true \
          -p:CorePackageVersion=${{ needs.publish-core.outputs.version }}
        dotnet pack ConsoleImage.Spectre/ConsoleImage.Spectre.csproj \
          -c Release \
          -o ./artifacts \
          -p:UseNuGetDependency=true \
          -p:CorePackageVersion=${{ needs.publish-core.outputs.version }}

    - name: NuGet Login (OIDC)
      id: nuget
      uses: NuGet/login@v1
      with:
        user: 'mostlylucid'

    - name: Publish Spectre to NuGet.org
      run: dotnet nuget push ./artifacts/*.nupkg --api-key ${{ steps.nuget.outputs.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate

    - name: Publish Spectre to GitHub Packages
      run: dotnet nuget push ./artifacts/*.nupkg --api-key ${{ secrets.GITHUB_TOKEN }} --source https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json --skip-duplicate

  # ============================================
  # Wait for Video to be available (for CLI verification)
  # ============================================
  wait-for-video:
    runs-on: ubuntu-latest
    needs: [publish-core, publish-video]
    steps:
    - name: Wait for Video package availability on NuGet
      run: |
        VERSION="${{ needs.publish-core.outputs.version }}"
        echo "Waiting for mostlylucid.consoleimage.video version ${VERSION} to be available on NuGet..."

        MAX_ATTEMPTS=60
        ATTEMPT=0

        while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
          ATTEMPT=$((ATTEMPT + 1))
          echo "Attempt ${ATTEMPT}/${MAX_ATTEMPTS}: Checking NuGet API..."

          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            "https://api.nuget.org/v3-flatcontainer/mostlylucid.consoleimage.video/${VERSION}/mostlylucid.consoleimage.video.${VERSION}.nupkg")

          if [ "$HTTP_STATUS" = "200" ]; then
            echo "Package mostlylucid.consoleimage.video ${VERSION} is available!"
            exit 0
          fi

          echo "Package not yet available (HTTP ${HTTP_STATUS}), waiting 30 seconds..."
          sleep 30
        done

        echo "ERROR: Timeout waiting for package availability on NuGet."
        exit 1

  # ============================================
  # Wait for Spectre to be available (for SpectreDemo verification)
  # ============================================
  wait-for-spectre:
    runs-on: ubuntu-latest
    needs: [publish-core, publish-spectre]
    steps:
    - name: Wait for Spectre package availability on NuGet
      run: |
        VERSION="${{ needs.publish-core.outputs.version }}"
        echo "Waiting for mostlylucid.consoleimage.spectre version ${VERSION} to be available on NuGet..."

        MAX_ATTEMPTS=60
        ATTEMPT=0

        while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
          ATTEMPT=$((ATTEMPT + 1))
          echo "Attempt ${ATTEMPT}/${MAX_ATTEMPTS}: Checking NuGet API..."

          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            "https://api.nuget.org/v3-flatcontainer/mostlylucid.consoleimage.spectre/${VERSION}/mostlylucid.consoleimage.spectre.${VERSION}.nupkg")

          if [ "$HTTP_STATUS" = "200" ]; then
            echo "Package mostlylucid.consoleimage.spectre ${VERSION} is available!"
            exit 0
          fi

          echo "Package not yet available (HTTP ${HTTP_STATUS}), waiting 30 seconds..."
          sleep 30
        done

        echo "ERROR: Timeout waiting for package availability on NuGet."
        exit 1

  # ============================================
  # Wait for Transcription to be available (for CLI)
  # ============================================
  wait-for-transcription:
    runs-on: ubuntu-latest
    needs: [publish-core, publish-transcription]
    steps:
    - name: Wait for Transcription package availability on NuGet
      run: |
        VERSION="${{ needs.publish-core.outputs.version }}"
        echo "Waiting for mostlylucid.consoleimage.transcription version ${VERSION} to be available on NuGet..."

        MAX_ATTEMPTS=60
        ATTEMPT=0

        while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
          ATTEMPT=$((ATTEMPT + 1))
          echo "Attempt ${ATTEMPT}/${MAX_ATTEMPTS}: Checking NuGet API..."

          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            "https://api.nuget.org/v3-flatcontainer/mostlylucid.consoleimage.transcription/${VERSION}/mostlylucid.consoleimage.transcription.${VERSION}.nupkg")

          if [ "$HTTP_STATUS" = "200" ]; then
            echo "Package mostlylucid.consoleimage.transcription ${VERSION} is available!"
            exit 0
          fi

          echo "Package not yet available (HTTP ${HTTP_STATUS}), waiting 30 seconds..."
          sleep 30
        done

        echo "ERROR: Timeout waiting for package availability on NuGet."
        exit 1

  # ============================================
  # STEP 5: Build ALL CLI binaries (AOT) for all platforms
  # ============================================
  build-cli:
    needs: [publish-player, publish-core, publish-video, publish-transcription, wait-for-core, wait-for-video, wait-for-transcription]
    strategy:
      matrix:
        include:
          - os: windows-latest
            rid: win-x64
            ext: .exe
          - os: windows-latest
            rid: win-arm64
            ext: .exe
          - os: ubuntu-latest
            rid: linux-x64
            ext: ''
          - os: ubuntu-24.04-arm
            rid: linux-arm64
            ext: ''
          - os: macos-latest
            rid: osx-arm64
            ext: ''

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install AOT prerequisites (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y clang zlib1g-dev

      - name: Restore with NuGet packages
        run: |
          dotnet restore ConsoleImage/ConsoleImage.csproj -p:UseNuGetDependency=true -p:CorePackageVersion=${{ needs.publish-core.outputs.version }} -p:BundleWhisperRuntime=true
          dotnet restore ConsoleImage.Mcp/ConsoleImage.Mcp.csproj -p:UseNuGetDependency=true -p:CorePackageVersion=${{ needs.publish-core.outputs.version }}

      - name: Publish AOT - consoleimage (with Whisper runtime)
        shell: bash
        run: |
          dotnet publish ConsoleImage/ConsoleImage.csproj \
            -c Release -r ${{ matrix.rid }} --self-contained true \
            -p:PublishAot=true -p:UseNuGetDependency=true \
            -p:BundleWhisperRuntime=true \
            -p:CorePackageVersion=${{ needs.publish-core.outputs.version }} \
            -o ./publish/consoleimage-${{ matrix.rid }}

      - name: Publish AOT - consoleimage-mcp
        shell: bash
        run: |
          dotnet publish ConsoleImage.Mcp/ConsoleImage.Mcp.csproj \
            -c Release -r ${{ matrix.rid }} --self-contained true \
            -p:PublishAot=true -p:UseNuGetDependency=true \
            -p:CorePackageVersion=${{ needs.publish-core.outputs.version }} \
            -o ./publish/consoleimage-mcp-${{ matrix.rid }}

      - name: Prepare archives
        shell: bash
        run: |
          # === ConsoleImage CLI (default - without Whisper native libs) ===
          mkdir -p ./archive/consoleimage-${{ matrix.rid }}
          if [ "${{ matrix.ext }}" == ".exe" ]; then
            cp ./publish/consoleimage-${{ matrix.rid }}/consoleimage.exe ./archive/consoleimage-${{ matrix.rid }}/
          else
            cp ./publish/consoleimage-${{ matrix.rid }}/consoleimage ./archive/consoleimage-${{ matrix.rid }}/
            chmod +x ./archive/consoleimage-${{ matrix.rid }}/consoleimage
          fi
          cp README.md ./archive/consoleimage-${{ matrix.rid }}/
          cp ConsoleImage/calibration.json ./archive/consoleimage-${{ matrix.rid }}/ || true

          # === ConsoleImage CLI + Whisper (with native libs for transcription) ===
          mkdir -p ./archive/consoleimage-${{ matrix.rid }}-whisper
          if [ "${{ matrix.ext }}" == ".exe" ]; then
            cp ./publish/consoleimage-${{ matrix.rid }}/consoleimage.exe ./archive/consoleimage-${{ matrix.rid }}-whisper/
            # Copy Whisper native DLLs (whisper.dll, ggml-*.dll)
            cp ./publish/consoleimage-${{ matrix.rid }}/*.dll ./archive/consoleimage-${{ matrix.rid }}-whisper/ 2>/dev/null || true
          else
            cp ./publish/consoleimage-${{ matrix.rid }}/consoleimage ./archive/consoleimage-${{ matrix.rid }}-whisper/
            chmod +x ./archive/consoleimage-${{ matrix.rid }}-whisper/consoleimage
            # Copy Whisper native libraries (.so on Linux, .dylib on macOS)
            cp ./publish/consoleimage-${{ matrix.rid }}/*.so ./archive/consoleimage-${{ matrix.rid }}-whisper/ 2>/dev/null || true
            cp ./publish/consoleimage-${{ matrix.rid }}/*.dylib ./archive/consoleimage-${{ matrix.rid }}-whisper/ 2>/dev/null || true
            cp ./publish/consoleimage-${{ matrix.rid }}/*.metal ./archive/consoleimage-${{ matrix.rid }}-whisper/ 2>/dev/null || true
          fi
          cp README.md ./archive/consoleimage-${{ matrix.rid }}-whisper/
          cp ConsoleImage/calibration.json ./archive/consoleimage-${{ matrix.rid }}-whisper/ || true

          # === ConsoleImage MCP Server ===
          mkdir -p ./archive/consoleimage-mcp-${{ matrix.rid }}
          if [ "${{ matrix.ext }}" == ".exe" ]; then
            cp ./publish/consoleimage-mcp-${{ matrix.rid }}/consoleimage-mcp.exe ./archive/consoleimage-mcp-${{ matrix.rid }}/
          else
            cp ./publish/consoleimage-mcp-${{ matrix.rid }}/consoleimage-mcp ./archive/consoleimage-mcp-${{ matrix.rid }}/
            chmod +x ./archive/consoleimage-mcp-${{ matrix.rid }}/consoleimage-mcp
          fi
          cp ConsoleImage.Mcp/README.md ./archive/consoleimage-mcp-${{ matrix.rid }}/

      - name: Archive (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          cd archive
          Compress-Archive -Path consoleimage-${{ matrix.rid }}/* -DestinationPath consoleimage-${{ matrix.rid }}.zip
          Compress-Archive -Path consoleimage-${{ matrix.rid }}-whisper/* -DestinationPath consoleimage-${{ matrix.rid }}-whisper.zip
          Compress-Archive -Path consoleimage-mcp-${{ matrix.rid }}/* -DestinationPath consoleimage-mcp-${{ matrix.rid }}.zip

      - name: Archive (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          cd archive/consoleimage-${{ matrix.rid }} && tar -czvf ../consoleimage-${{ matrix.rid }}.tar.gz * && cd ..
          cd consoleimage-${{ matrix.rid }}-whisper && tar -czvf ../consoleimage-${{ matrix.rid }}-whisper.tar.gz * && cd ..
          cd consoleimage-mcp-${{ matrix.rid }} && tar -czvf ../consoleimage-mcp-${{ matrix.rid }}.tar.gz *

      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          name: cli-${{ matrix.rid }}
          path: |
            archive/*.zip
            archive/*.tar.gz

  # ============================================
  # STEP 5: Create GitHub Release with all CLI binaries
  # ============================================
  release:
    needs: [publish-core, publish-video, publish-transcription, publish-spectre, publish-player, build-cli]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts

      - name: Display structure
        run: ls -R artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: consoleimage-v${{ needs.publish-core.outputs.version }}
          name: ConsoleImage ${{ needs.publish-core.outputs.version }}
          body: |
            ## ConsoleImage Suite ${{ needs.publish-core.outputs.version }}

            **Combined release** of all ConsoleImage CLI tools and NuGet packages.
            High-quality ASCII art renderer using [Alex Harri's shape-matching algorithm](https://alexharri.com/blog/ascii-rendering).

            ### CLI Downloads

            Two variants available:
            - **consoleimage**  -  Core CLI for images, GIFs, videos, documents (smaller download)
            - **consoleimage + whisper**  -  Same binary + Whisper native libraries for AI-powered transcription

            | Platform | consoleimage | + whisper | consoleimage-mcp |
            |----------|--------------|----------|------------------|
            | Windows x64 | `consoleimage-win-x64.zip` | `consoleimage-win-x64-whisper.zip` | `consoleimage-mcp-win-x64.zip` |
            | Windows ARM64 | `consoleimage-win-arm64.zip` | `consoleimage-win-arm64-whisper.zip` | `consoleimage-mcp-win-arm64.zip` |
            | Linux x64 | `consoleimage-linux-x64.tar.gz` | `consoleimage-linux-x64-whisper.tar.gz` | `consoleimage-mcp-linux-x64.tar.gz` |
            | Linux ARM64 | `consoleimage-linux-arm64.tar.gz` | `consoleimage-linux-arm64-whisper.tar.gz` | `consoleimage-mcp-linux-arm64.tar.gz` |
            | macOS ARM64 | `consoleimage-osx-arm64.tar.gz` | `consoleimage-osx-arm64-whisper.tar.gz` | `consoleimage-mcp-osx-arm64.tar.gz` |

            > **Which one do I need?** The default `consoleimage` handles images, GIFs, videos, subtitles from files/embedded/YouTube, and document playback. Download the `whisper` variant if you want to generate subtitles from speech using local AI transcription (`--subs whisper`).

            ---

            ### consoleimage - Unified CLI for Images, GIFs, Videos, Documents

            ```bash
            # Images
            consoleimage photo.jpg
            consoleimage photo.png --blocks      # Unicode color blocks (▀▄)
            consoleimage photo.png --braille     # Braille patterns
            consoleimage photo.png --matrix      # Matrix digital rain

            # Animated GIFs
            consoleimage animation.gif --speed 1.5 --loop 3

            # Videos (FFmpeg auto-downloads on first use)
            consoleimage movie.mp4
            consoleimage movie.mp4 --blocks -w 120
            consoleimage movie.mp4 --ss 60 -t 30    # Start at 60s, play 30s

            # Subtitles (embedded, external, or YouTube - no Whisper needed)
            consoleimage movie.mkv --subs auto
            consoleimage movie.mp4 --subs movie.srt

            # AI Transcription (requires whisper variant)
            consoleimage movie.mp4 --subs whisper

            # Save to compressed document (.cidz)
            consoleimage animation.gif -o output.cidz
            consoleimage movie.mp4 -o movie.cidz --blocks

            # Play saved documents
            consoleimage output.cidz --speed 2.0

            # Convert to GIF
            consoleimage movie.cidz -o movie.gif

            # Show status line with progress
            consoleimage animation.gif --status
            ```

            ---

            ### consoleimage-mcp - MCP Server for AI Tools

            Add to Claude Desktop (`claude_desktop_config.json`):
            ```json
            {
              "mcpServers": {
                "consoleimage": {
                  "command": "C:/path/to/consoleimage-mcp.exe"
                }
              }
            }
            ```

            **Available MCP Tools:**
            | Tool | Description |
            |------|-------------|
            | `render_image` | Render image/GIF to ASCII art |
            | `render_to_gif` | Create ASCII art GIF file |
            | `get_image_info` | Get image metadata (dimensions, format, EXIF) |
            | `get_gif_info` | Get GIF frame count and dimensions |
            | `get_video_info` | Get video metadata (duration, resolution, codec) |
            | `list_render_modes` | List available render modes |
            | `list_matrix_presets` | List Matrix color presets |
            | `compare_render_modes` | Compare all modes side-by-side |

            ---

            ### NuGet Packages (for .NET developers)
            ```bash
            # Full rendering library (requires ImageSharp)
            dotnet add package mostlylucid.consoleimage --version ${{ needs.publish-core.outputs.version }}

            # Zero-dependency player for .cidz documents (AOT compatible)
            dotnet add package mostlylucid.consoleimage.player --version ${{ needs.publish-core.outputs.version }}

            # Video support (requires FFmpeg)
            dotnet add package mostlylucid.consoleimage.video --version ${{ needs.publish-core.outputs.version }}

            # Whisper transcription for auto-subtitles
            dotnet add package mostlylucid.consoleimage.transcription --version ${{ needs.publish-core.outputs.version }}

            # Spectre.Console integration
            dotnet add package mostlylucid.consoleimage.spectre --version ${{ needs.publish-core.outputs.version }}
            ```

            ### Features
            - **Four render modes**: ASCII art, Unicode color blocks, Braille patterns, Matrix rain
            - **Animated playback**: GIFs and videos with flicker-free DECSET 2026 sync
            - **Auto-fits to terminal**: Output defaults to your console size
            - **AOT compiled**: Fast startup, no .NET runtime required
            - **Whisper variant**: Optional AI transcription with bundled native libraries
            - **Cross-platform**: Windows, Linux, macOS (x64 and ARM64)

          files: |
            artifacts/**/*.zip
            artifacts/**/*.tar.gz
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================
  # Summary
  # ============================================
  summary:
    runs-on: ubuntu-latest
    needs: [publish-core, publish-video, publish-transcription, publish-spectre, publish-player, build-cli, release]
    if: always()
    steps:
    - name: Summary
      run: |
        VERSION="${{ needs.publish-core.outputs.version }}"
        echo "## Published Packages (v${VERSION})" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Package | Version | NuGet |" >> $GITHUB_STEP_SUMMARY
        echo "|---------|---------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| mostlylucid.consoleimage | ${VERSION} | [NuGet](https://www.nuget.org/packages/mostlylucid.consoleimage/${VERSION}) |" >> $GITHUB_STEP_SUMMARY
        echo "| mostlylucid.consoleimage.player | ${VERSION} | [NuGet](https://www.nuget.org/packages/mostlylucid.consoleimage.player/${VERSION}) |" >> $GITHUB_STEP_SUMMARY
        echo "| mostlylucid.consoleimage.video | ${VERSION} | [NuGet](https://www.nuget.org/packages/mostlylucid.consoleimage.video/${VERSION}) |" >> $GITHUB_STEP_SUMMARY
        echo "| mostlylucid.consoleimage.transcription | ${VERSION} | [NuGet](https://www.nuget.org/packages/mostlylucid.consoleimage.transcription/${VERSION}) |" >> $GITHUB_STEP_SUMMARY
        echo "| mostlylucid.consoleimage.spectre | ${VERSION} | [NuGet](https://www.nuget.org/packages/mostlylucid.consoleimage.spectre/${VERSION}) |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## CLI Releases" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| CLI | Platforms |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|-----------|" >> $GITHUB_STEP_SUMMARY
        echo "| consoleimage | win-x64, win-arm64, linux-x64, linux-arm64, osx-arm64 |" >> $GITHUB_STEP_SUMMARY
        echo "| consoleimage + whisper | win-x64, win-arm64, linux-x64, linux-arm64, osx-arm64 |" >> $GITHUB_STEP_SUMMARY
        echo "| consoleimage-mcp | win-x64, win-arm64, linux-x64, linux-arm64, osx-arm64 |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "[View Release](https://github.com/${{ github.repository }}/releases/tag/consoleimage-v${VERSION})" >> $GITHUB_STEP_SUMMARY
