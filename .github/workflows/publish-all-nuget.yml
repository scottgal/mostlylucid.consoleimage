name: Publish All NuGet Packages

# This workflow publishes ALL NuGet packages:
# 1. ConsoleImage.Core → wait for NuGet availability
# 2. ConsoleImage.Video.Core (needs Core) ─┬─ run in parallel after Core is available
# 3. ConsoleImage.Spectre (needs Core)    ─┘
# 4. Build CLIs using the NuGet packages (verification)

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version for ALL packages (e.g., 2.5.1)'
        required: true

permissions:
  id-token: write
  contents: read
  packages: write

jobs:
  # ============================================
  # STEP 1: Publish Core package
  # ============================================
  publish-core:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ github.event.inputs.version }}
    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - uses: actions/setup-dotnet@v5
      with:
        dotnet-version: '10.0.x'

    - name: Create version tag for MinVer
      run: |
        TAG="consoleimage-v${{ github.event.inputs.version }}"
        if git rev-parse "$TAG" >/dev/null 2>&1; then
          echo "Tag $TAG already exists, skipping creation"
        else
          git tag "$TAG"
          echo "Created tag $TAG"
        fi

    - name: Build & Pack Core
      run: |
        dotnet restore ConsoleImage.Core/ConsoleImage.Core.csproj
        dotnet pack ConsoleImage.Core/ConsoleImage.Core.csproj -c Release -o ./artifacts

    - name: NuGet Login (OIDC)
      id: nuget
      uses: NuGet/login@v1
      with:
        user: 'mostlylucid'

    - name: Publish Core to NuGet.org
      run: dotnet nuget push ./artifacts/*.nupkg --api-key ${{ steps.nuget.outputs.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate

    - name: Publish Core to GitHub Packages
      run: dotnet nuget push ./artifacts/*.nupkg --api-key ${{ secrets.GITHUB_TOKEN }} --source https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json --skip-duplicate

  # ============================================
  # Wait for Core to be available on NuGet
  # ============================================
  wait-for-core:
    runs-on: ubuntu-latest
    needs: publish-core
    steps:
    - name: Wait for Core package availability on NuGet
      run: |
        VERSION="${{ needs.publish-core.outputs.version }}"
        echo "Waiting for mostlylucid.consoleimage version ${VERSION} to be available on NuGet..."

        MAX_ATTEMPTS=60
        ATTEMPT=0

        while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
          ATTEMPT=$((ATTEMPT + 1))
          echo "Attempt ${ATTEMPT}/${MAX_ATTEMPTS}: Checking NuGet API..."

          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            "https://api.nuget.org/v3-flatcontainer/mostlylucid.consoleimage/${VERSION}/mostlylucid.consoleimage.${VERSION}.nupkg")

          if [ "$HTTP_STATUS" = "200" ]; then
            echo "Package mostlylucid.consoleimage ${VERSION} is available!"
            exit 0
          fi

          echo "Package not yet available (HTTP ${HTTP_STATUS}), waiting 30 seconds..."
          sleep 30
        done

        echo "Warning: Timeout waiting for package. It may still be indexing."
        exit 0

  # ============================================
  # STEP 2: Publish Video (depends on Core)
  # ============================================
  publish-video:
    runs-on: ubuntu-latest
    needs: [publish-core, wait-for-core]
    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - uses: actions/setup-dotnet@v5
      with:
        dotnet-version: '10.0.x'

    - name: Create version tag for MinVer
      run: |
        TAG="consoleimage-video-v${{ needs.publish-core.outputs.version }}"
        if git rev-parse "$TAG" >/dev/null 2>&1; then
          echo "Tag $TAG already exists, skipping creation"
        else
          git tag "$TAG"
          echo "Created tag $TAG"
        fi

    - name: Build & Pack Video.Core
      run: |
        dotnet restore ConsoleImage.Video.Core/ConsoleImage.Video.Core.csproj \
          -p:UseNuGetDependency=true \
          -p:CorePackageVersion=${{ needs.publish-core.outputs.version }}
        dotnet pack ConsoleImage.Video.Core/ConsoleImage.Video.Core.csproj \
          -c Release \
          -o ./artifacts \
          -p:UseNuGetDependency=true \
          -p:CorePackageVersion=${{ needs.publish-core.outputs.version }}

    - name: NuGet Login (OIDC)
      id: nuget
      uses: NuGet/login@v1
      with:
        user: 'mostlylucid'

    - name: Publish Video.Core to NuGet.org
      run: dotnet nuget push ./artifacts/*.nupkg --api-key ${{ steps.nuget.outputs.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate

    - name: Publish Video.Core to GitHub Packages
      run: dotnet nuget push ./artifacts/*.nupkg --api-key ${{ secrets.GITHUB_TOKEN }} --source https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json --skip-duplicate

  # ============================================
  # STEP 3: Publish Spectre (depends on Core, parallel with Video)
  # ============================================
  publish-spectre:
    runs-on: ubuntu-latest
    needs: [publish-core, wait-for-core]
    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - uses: actions/setup-dotnet@v5
      with:
        dotnet-version: '10.0.x'

    - name: Create version tag for MinVer
      run: |
        TAG="consoleimage-spectre-v${{ needs.publish-core.outputs.version }}"
        if git rev-parse "$TAG" >/dev/null 2>&1; then
          echo "Tag $TAG already exists, skipping creation"
        else
          git tag "$TAG"
          echo "Created tag $TAG"
        fi

    - name: Build & Pack Spectre
      run: |
        dotnet restore ConsoleImage.Spectre/ConsoleImage.Spectre.csproj \
          -p:UseNuGetDependency=true \
          -p:CorePackageVersion=${{ needs.publish-core.outputs.version }}
        dotnet pack ConsoleImage.Spectre/ConsoleImage.Spectre.csproj \
          -c Release \
          -o ./artifacts \
          -p:UseNuGetDependency=true \
          -p:CorePackageVersion=${{ needs.publish-core.outputs.version }}

    - name: NuGet Login (OIDC)
      id: nuget
      uses: NuGet/login@v1
      with:
        user: 'mostlylucid'

    - name: Publish Spectre to NuGet.org
      run: dotnet nuget push ./artifacts/*.nupkg --api-key ${{ steps.nuget.outputs.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate

    - name: Publish Spectre to GitHub Packages
      run: dotnet nuget push ./artifacts/*.nupkg --api-key ${{ secrets.GITHUB_TOKEN }} --source https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json --skip-duplicate

  # ============================================
  # Wait for Video to be available (for CLI verification)
  # ============================================
  wait-for-video:
    runs-on: ubuntu-latest
    needs: [publish-core, publish-video]
    steps:
    - name: Wait for Video package availability on NuGet
      run: |
        VERSION="${{ needs.publish-core.outputs.version }}"
        echo "Waiting for mostlylucid.consoleimage.video version ${VERSION} to be available on NuGet..."

        MAX_ATTEMPTS=60
        ATTEMPT=0

        while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
          ATTEMPT=$((ATTEMPT + 1))
          echo "Attempt ${ATTEMPT}/${MAX_ATTEMPTS}: Checking NuGet API..."

          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            "https://api.nuget.org/v3-flatcontainer/mostlylucid.consoleimage.video/${VERSION}/mostlylucid.consoleimage.video.${VERSION}.nupkg")

          if [ "$HTTP_STATUS" = "200" ]; then
            echo "Package mostlylucid.consoleimage.video ${VERSION} is available!"
            exit 0
          fi

          echo "Package not yet available (HTTP ${HTTP_STATUS}), waiting 30 seconds..."
          sleep 30
        done

        echo "Warning: Timeout waiting for package. It may still be indexing."
        exit 0

  # ============================================
  # STEP 4: Build CLIs using NuGet packages (verification)
  # ============================================
  verify-cli-builds:
    runs-on: ubuntu-latest
    needs: [publish-core, wait-for-core, publish-video, wait-for-video]
    steps:
    - uses: actions/checkout@v6

    - uses: actions/setup-dotnet@v5
      with:
        dotnet-version: '10.0.x'

    - name: Build consoleimage CLI using NuGet package
      run: |
        dotnet build ConsoleImage/ConsoleImage.csproj -c Release \
          -p:UseNuGetDependency=true \
          -p:CorePackageVersion=${{ needs.publish-core.outputs.version }}

    - name: Build consolevideo CLI using NuGet package
      run: |
        dotnet build ConsoleImage.Video/ConsoleImage.Video.csproj -c Release \
          -p:UseNuGetDependency=true \
          -p:VideoPackageVersion=${{ needs.publish-core.outputs.version }}

    - name: Verification passed
      run: echo "Both CLIs built successfully using NuGet packages!"

  # ============================================
  # Summary
  # ============================================
  summary:
    runs-on: ubuntu-latest
    needs: [publish-core, publish-video, publish-spectre, verify-cli-builds]
    if: always()
    steps:
    - name: Summary
      run: |
        VERSION="${{ needs.publish-core.outputs.version }}"
        echo "## Published Packages (v${VERSION})" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Package | Version | NuGet | GitHub |" >> $GITHUB_STEP_SUMMARY
        echo "|---------|---------|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| mostlylucid.consoleimage | ${VERSION} | [NuGet](https://www.nuget.org/packages/mostlylucid.consoleimage/${VERSION}) | [GitHub](https://github.com/${{ github.repository_owner }}/ConsoleImage/packages) |" >> $GITHUB_STEP_SUMMARY
        echo "| mostlylucid.consoleimage.video | ${VERSION} | [NuGet](https://www.nuget.org/packages/mostlylucid.consoleimage.video/${VERSION}) | [GitHub](https://github.com/${{ github.repository_owner }}/ConsoleImage/packages) |" >> $GITHUB_STEP_SUMMARY
        echo "| mostlylucid.consoleimage.spectre | ${VERSION} | [NuGet](https://www.nuget.org/packages/mostlylucid.consoleimage.spectre/${VERSION}) | [GitHub](https://github.com/${{ github.repository_owner }}/ConsoleImage/packages) |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### CLI Verification" >> $GITHUB_STEP_SUMMARY
        echo "- consoleimage: ${{ needs.verify-cli-builds.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- consolevideo: ${{ needs.verify-cli-builds.result }}" >> $GITHUB_STEP_SUMMARY
