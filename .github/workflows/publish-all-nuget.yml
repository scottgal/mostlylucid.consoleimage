name: Publish All NuGet Packages

# This workflow publishes ALL NuGet packages AND CLI releases:
# 1. ConsoleImage.Core → wait for NuGet availability
# 2. ConsoleImage.Video.Core (needs Core) ─┬─ run in parallel after Core is available
# 3. ConsoleImage.Spectre (needs Core)    ─┘
# 4. Build & release CLI binaries (consoleimage, consolevideo, consoleimage-mcp)

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version for ALL packages (e.g., 2.5.1)'
        required: true

permissions:
  id-token: write
  contents: write
  packages: write

env:
  DOTNET_VERSION: '10.0.x'

jobs:
  # ============================================
  # STEP 1: Publish Core package
  # ============================================
  publish-core:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ github.event.inputs.version }}
    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - uses: actions/setup-dotnet@v5
      with:
        dotnet-version: '10.0.x'

    - name: Create version tag for MinVer
      run: |
        TAG="consoleimage-v${{ github.event.inputs.version }}"
        if git rev-parse "$TAG" >/dev/null 2>&1; then
          echo "Tag $TAG already exists, skipping creation"
        else
          git tag "$TAG"
          echo "Created tag $TAG"
        fi

    - name: Build & Pack Core
      run: |
        dotnet restore ConsoleImage.Core/ConsoleImage.Core.csproj
        dotnet pack ConsoleImage.Core/ConsoleImage.Core.csproj -c Release -o ./artifacts

    - name: NuGet Login (OIDC)
      id: nuget
      uses: NuGet/login@v1
      with:
        user: 'mostlylucid'

    - name: Publish Core to NuGet.org
      run: dotnet nuget push ./artifacts/*.nupkg --api-key ${{ steps.nuget.outputs.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate

    - name: Publish Core to GitHub Packages
      run: dotnet nuget push ./artifacts/*.nupkg --api-key ${{ secrets.GITHUB_TOKEN }} --source https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json --skip-duplicate

  # ============================================
  # Wait for Core to be available on NuGet
  # ============================================
  wait-for-core:
    runs-on: ubuntu-latest
    needs: publish-core
    steps:
    - name: Wait for Core package availability on NuGet
      run: |
        VERSION="${{ needs.publish-core.outputs.version }}"
        echo "Waiting for mostlylucid.consoleimage version ${VERSION} to be available on NuGet..."

        MAX_ATTEMPTS=60
        ATTEMPT=0

        while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
          ATTEMPT=$((ATTEMPT + 1))
          echo "Attempt ${ATTEMPT}/${MAX_ATTEMPTS}: Checking NuGet API..."

          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            "https://api.nuget.org/v3-flatcontainer/mostlylucid.consoleimage/${VERSION}/mostlylucid.consoleimage.${VERSION}.nupkg")

          if [ "$HTTP_STATUS" = "200" ]; then
            echo "Package mostlylucid.consoleimage ${VERSION} is available!"
            exit 0
          fi

          echo "Package not yet available (HTTP ${HTTP_STATUS}), waiting 30 seconds..."
          sleep 30
        done

        echo "Warning: Timeout waiting for package. It may still be indexing."
        exit 0

  # ============================================
  # STEP 2: Publish Video (depends on Core)
  # ============================================
  publish-video:
    runs-on: ubuntu-latest
    needs: [publish-core, wait-for-core]
    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - uses: actions/setup-dotnet@v5
      with:
        dotnet-version: '10.0.x'

    - name: Create version tag for MinVer
      run: |
        TAG="consoleimage-video-v${{ needs.publish-core.outputs.version }}"
        if git rev-parse "$TAG" >/dev/null 2>&1; then
          echo "Tag $TAG already exists, skipping creation"
        else
          git tag "$TAG"
          echo "Created tag $TAG"
        fi

    - name: Build & Pack Video.Core
      run: |
        dotnet restore ConsoleImage.Video.Core/ConsoleImage.Video.Core.csproj \
          -p:UseNuGetDependency=true \
          -p:CorePackageVersion=${{ needs.publish-core.outputs.version }}
        dotnet pack ConsoleImage.Video.Core/ConsoleImage.Video.Core.csproj \
          -c Release \
          -o ./artifacts \
          -p:UseNuGetDependency=true \
          -p:CorePackageVersion=${{ needs.publish-core.outputs.version }}

    - name: NuGet Login (OIDC)
      id: nuget
      uses: NuGet/login@v1
      with:
        user: 'mostlylucid'

    - name: Publish Video.Core to NuGet.org
      run: dotnet nuget push ./artifacts/*.nupkg --api-key ${{ steps.nuget.outputs.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate

    - name: Publish Video.Core to GitHub Packages
      run: dotnet nuget push ./artifacts/*.nupkg --api-key ${{ secrets.GITHUB_TOKEN }} --source https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json --skip-duplicate

  # ============================================
  # STEP 3: Publish Spectre (depends on Core, parallel with Video)
  # ============================================
  publish-spectre:
    runs-on: ubuntu-latest
    needs: [publish-core, wait-for-core]
    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - uses: actions/setup-dotnet@v5
      with:
        dotnet-version: '10.0.x'

    - name: Create version tag for MinVer
      run: |
        TAG="consoleimage-spectre-v${{ needs.publish-core.outputs.version }}"
        if git rev-parse "$TAG" >/dev/null 2>&1; then
          echo "Tag $TAG already exists, skipping creation"
        else
          git tag "$TAG"
          echo "Created tag $TAG"
        fi

    - name: Build & Pack Spectre
      run: |
        dotnet restore ConsoleImage.Spectre/ConsoleImage.Spectre.csproj \
          -p:UseNuGetDependency=true \
          -p:CorePackageVersion=${{ needs.publish-core.outputs.version }}
        dotnet pack ConsoleImage.Spectre/ConsoleImage.Spectre.csproj \
          -c Release \
          -o ./artifacts \
          -p:UseNuGetDependency=true \
          -p:CorePackageVersion=${{ needs.publish-core.outputs.version }}

    - name: NuGet Login (OIDC)
      id: nuget
      uses: NuGet/login@v1
      with:
        user: 'mostlylucid'

    - name: Publish Spectre to NuGet.org
      run: dotnet nuget push ./artifacts/*.nupkg --api-key ${{ steps.nuget.outputs.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate

    - name: Publish Spectre to GitHub Packages
      run: dotnet nuget push ./artifacts/*.nupkg --api-key ${{ secrets.GITHUB_TOKEN }} --source https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json --skip-duplicate

  # ============================================
  # Wait for Video to be available (for CLI verification)
  # ============================================
  wait-for-video:
    runs-on: ubuntu-latest
    needs: [publish-core, publish-video]
    steps:
    - name: Wait for Video package availability on NuGet
      run: |
        VERSION="${{ needs.publish-core.outputs.version }}"
        echo "Waiting for mostlylucid.consoleimage.video version ${VERSION} to be available on NuGet..."

        MAX_ATTEMPTS=60
        ATTEMPT=0

        while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
          ATTEMPT=$((ATTEMPT + 1))
          echo "Attempt ${ATTEMPT}/${MAX_ATTEMPTS}: Checking NuGet API..."

          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            "https://api.nuget.org/v3-flatcontainer/mostlylucid.consoleimage.video/${VERSION}/mostlylucid.consoleimage.video.${VERSION}.nupkg")

          if [ "$HTTP_STATUS" = "200" ]; then
            echo "Package mostlylucid.consoleimage.video ${VERSION} is available!"
            exit 0
          fi

          echo "Package not yet available (HTTP ${HTTP_STATUS}), waiting 30 seconds..."
          sleep 30
        done

        echo "Warning: Timeout waiting for package. It may still be indexing."
        exit 0

  # ============================================
  # Wait for Spectre to be available (for SpectreDemo verification)
  # ============================================
  wait-for-spectre:
    runs-on: ubuntu-latest
    needs: [publish-core, publish-spectre]
    steps:
    - name: Wait for Spectre package availability on NuGet
      run: |
        VERSION="${{ needs.publish-core.outputs.version }}"
        echo "Waiting for mostlylucid.consoleimage.spectre version ${VERSION} to be available on NuGet..."

        MAX_ATTEMPTS=60
        ATTEMPT=0

        while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
          ATTEMPT=$((ATTEMPT + 1))
          echo "Attempt ${ATTEMPT}/${MAX_ATTEMPTS}: Checking NuGet API..."

          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            "https://api.nuget.org/v3-flatcontainer/mostlylucid.consoleimage.spectre/${VERSION}/mostlylucid.consoleimage.spectre.${VERSION}.nupkg")

          if [ "$HTTP_STATUS" = "200" ]; then
            echo "Package mostlylucid.consoleimage.spectre ${VERSION} is available!"
            exit 0
          fi

          echo "Package not yet available (HTTP ${HTTP_STATUS}), waiting 30 seconds..."
          sleep 30
        done

        echo "Warning: Timeout waiting for package. It may still be indexing."
        exit 0

  # ============================================
  # STEP 4: Build ALL CLI binaries (AOT) for all platforms
  # ============================================
  build-cli:
    needs: [publish-core, publish-video, wait-for-core, wait-for-video]
    strategy:
      matrix:
        include:
          - os: windows-latest
            rid: win-x64
            ext: .exe
          - os: ubuntu-latest
            rid: linux-x64
            ext: ''
          - os: ubuntu-24.04-arm
            rid: linux-arm64
            ext: ''
          - os: macos-latest
            rid: osx-arm64
            ext: ''

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install AOT prerequisites (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y clang zlib1g-dev

      - name: Restore with NuGet packages
        run: |
          dotnet restore ConsoleImage/ConsoleImage.csproj -p:UseNuGetDependency=true -p:CorePackageVersion=${{ needs.publish-core.outputs.version }}
          dotnet restore ConsoleImage.Video/ConsoleImage.Video.csproj -p:UseNuGetDependency=true -p:VideoPackageVersion=${{ needs.publish-core.outputs.version }}
          dotnet restore ConsoleImage.Mcp/ConsoleImage.Mcp.csproj -p:UseNuGetDependency=true -p:CorePackageVersion=${{ needs.publish-core.outputs.version }} -p:VideoPackageVersion=${{ needs.publish-core.outputs.version }}

      - name: Publish AOT - consoleimage
        shell: bash
        run: |
          dotnet publish ConsoleImage/ConsoleImage.csproj \
            -c Release -r ${{ matrix.rid }} --self-contained true \
            -p:PublishAot=true -p:UseNuGetDependency=true \
            -p:CorePackageVersion=${{ needs.publish-core.outputs.version }} \
            -o ./publish/consoleimage-${{ matrix.rid }}

      - name: Publish AOT - consolevideo
        shell: bash
        run: |
          dotnet publish ConsoleImage.Video/ConsoleImage.Video.csproj \
            -c Release -r ${{ matrix.rid }} --self-contained true \
            -p:PublishAot=true -p:UseNuGetDependency=true \
            -p:VideoPackageVersion=${{ needs.publish-core.outputs.version }} \
            -o ./publish/consolevideo-${{ matrix.rid }}

      - name: Publish AOT - consoleimage-mcp
        shell: bash
        run: |
          dotnet publish ConsoleImage.Mcp/ConsoleImage.Mcp.csproj \
            -c Release -r ${{ matrix.rid }} --self-contained true \
            -p:PublishAot=true -p:UseNuGetDependency=true \
            -p:CorePackageVersion=${{ needs.publish-core.outputs.version }} \
            -p:VideoPackageVersion=${{ needs.publish-core.outputs.version }} \
            -o ./publish/consoleimage-mcp-${{ matrix.rid }}

      - name: Prepare archives
        shell: bash
        run: |
          # consoleimage
          mkdir -p ./archive/consoleimage-${{ matrix.rid }}
          if [ "${{ matrix.ext }}" == ".exe" ]; then
            cp ./publish/consoleimage-${{ matrix.rid }}/consoleimage.exe ./archive/consoleimage-${{ matrix.rid }}/
          else
            cp ./publish/consoleimage-${{ matrix.rid }}/consoleimage ./archive/consoleimage-${{ matrix.rid }}/
            chmod +x ./archive/consoleimage-${{ matrix.rid }}/consoleimage
          fi
          cp README.md ./archive/consoleimage-${{ matrix.rid }}/
          cp ConsoleImage/calibration.json ./archive/consoleimage-${{ matrix.rid }}/ || true

          # consolevideo
          mkdir -p ./archive/consolevideo-${{ matrix.rid }}
          if [ "${{ matrix.ext }}" == ".exe" ]; then
            cp ./publish/consolevideo-${{ matrix.rid }}/consolevideo.exe ./archive/consolevideo-${{ matrix.rid }}/
          else
            cp ./publish/consolevideo-${{ matrix.rid }}/consolevideo ./archive/consolevideo-${{ matrix.rid }}/
            chmod +x ./archive/consolevideo-${{ matrix.rid }}/consolevideo
          fi
          cp ConsoleImage.Video/README.md ./archive/consolevideo-${{ matrix.rid }}/ || cp README.md ./archive/consolevideo-${{ matrix.rid }}/

          # consoleimage-mcp
          mkdir -p ./archive/consoleimage-mcp-${{ matrix.rid }}
          if [ "${{ matrix.ext }}" == ".exe" ]; then
            cp ./publish/consoleimage-mcp-${{ matrix.rid }}/consoleimage-mcp.exe ./archive/consoleimage-mcp-${{ matrix.rid }}/
          else
            cp ./publish/consoleimage-mcp-${{ matrix.rid }}/consoleimage-mcp ./archive/consoleimage-mcp-${{ matrix.rid }}/
            chmod +x ./archive/consoleimage-mcp-${{ matrix.rid }}/consoleimage-mcp
          fi
          cp ConsoleImage.Mcp/README.md ./archive/consoleimage-mcp-${{ matrix.rid }}/

      - name: Archive (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          cd archive
          Compress-Archive -Path consoleimage-${{ matrix.rid }}/* -DestinationPath consoleimage-${{ matrix.rid }}.zip
          Compress-Archive -Path consolevideo-${{ matrix.rid }}/* -DestinationPath consolevideo-${{ matrix.rid }}.zip
          Compress-Archive -Path consoleimage-mcp-${{ matrix.rid }}/* -DestinationPath consoleimage-mcp-${{ matrix.rid }}.zip

      - name: Archive (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          cd archive/consoleimage-${{ matrix.rid }} && tar -czvf ../consoleimage-${{ matrix.rid }}.tar.gz * && cd ..
          cd consolevideo-${{ matrix.rid }} && tar -czvf ../consolevideo-${{ matrix.rid }}.tar.gz * && cd ..
          cd consoleimage-mcp-${{ matrix.rid }} && tar -czvf ../consoleimage-mcp-${{ matrix.rid }}.tar.gz *

      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          name: cli-${{ matrix.rid }}
          path: |
            archive/*.zip
            archive/*.tar.gz

  # ============================================
  # STEP 5: Create GitHub Release with all CLI binaries
  # ============================================
  release:
    needs: [publish-core, publish-video, publish-spectre, build-cli]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts

      - name: Display structure
        run: ls -R artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: consoleimage-v${{ needs.publish-core.outputs.version }}
          name: ConsoleImage ${{ needs.publish-core.outputs.version }}
          body: |
            ## ConsoleImage Suite ${{ needs.publish-core.outputs.version }}

            **Combined release** of all ConsoleImage CLI tools and NuGet packages.
            High-quality ASCII art renderer using [Alex Harri's shape-matching algorithm](https://alexharri.com/blog/ascii-rendering).

            ### CLI Downloads

            | Platform | consoleimage | consolevideo | consoleimage-mcp |
            |----------|--------------|--------------|------------------|
            | Windows x64 | `consoleimage-win-x64.zip` | `consolevideo-win-x64.zip` | `consoleimage-mcp-win-x64.zip` |
            | Linux x64 | `consoleimage-linux-x64.tar.gz` | `consolevideo-linux-x64.tar.gz` | `consoleimage-mcp-linux-x64.tar.gz` |
            | Linux ARM64 | `consoleimage-linux-arm64.tar.gz` | `consolevideo-linux-arm64.tar.gz` | `consoleimage-mcp-linux-arm64.tar.gz` |
            | macOS ARM64 | `consoleimage-osx-arm64.tar.gz` | `consolevideo-osx-arm64.tar.gz` | `consoleimage-mcp-osx-arm64.tar.gz` |

            ---

            ### consoleimage - Image & GIF to ASCII

            ```bash
            # Basic usage - render image to terminal
            consoleimage photo.jpg

            # Render modes
            consoleimage photo.png --blocks      # Unicode color blocks (▀▄) - highest fidelity
            consoleimage photo.png --braille     # Braille patterns - ultra-high resolution
            consoleimage photo.png --matrix      # Matrix digital rain effect

            # Animated GIF playback
            consoleimage animation.gif
            consoleimage animation.gif --speed 1.5 --loop 3

            # Output to file
            consoleimage animation.gif -o output.gif    # Create animated GIF
            consoleimage photo.png -o render.json       # Save as JSON document

            # Size control
            consoleimage photo.jpg -w 120              # Set width (auto-fits to terminal by default)
            consoleimage photo.jpg -w 80 -h 40        # Set both dimensions

            # Show status line with progress
            consoleimage animation.gif --status
            ```

            ---

            ### consolevideo - Video to ASCII (FFmpeg)

            ```bash
            # Play video as ASCII art (auto-downloads FFmpeg if needed)
            consolevideo movie.mp4

            # Render modes (same as consoleimage)
            consolevideo movie.mp4 --blocks
            consolevideo movie.mp4 --braille
            consolevideo movie.mp4 --matrix

            # Size and speed control
            consolevideo movie.mp4 -w 120 --speed 2.0

            # Output to animated GIF
            consolevideo movie.mp4 -o output.gif --gif-colors 64

            # Show status line with timing info
            consolevideo movie.mp4 --status
            ```

            ---

            ### consoleimage-mcp - MCP Server for AI Tools

            Add to Claude Desktop (`claude_desktop_config.json`):
            ```json
            {
              "mcpServers": {
                "consoleimage": {
                  "command": "C:/path/to/consoleimage-mcp.exe"
                }
              }
            }
            ```

            **Available MCP Tools:**
            | Tool | Description |
            |------|-------------|
            | `render_image` | Render image/GIF to ASCII art |
            | `render_to_gif` | Create ASCII art GIF file |
            | `get_image_info` | Get image metadata (dimensions, format, EXIF) |
            | `get_gif_info` | Get GIF frame count and dimensions |
            | `get_video_info` | Get video metadata (duration, resolution, codec) |
            | `list_render_modes` | List available render modes |
            | `list_matrix_presets` | List Matrix color presets |
            | `compare_render_modes` | Compare all modes side-by-side |

            ---

            ### NuGet Packages (for .NET developers)
            ```bash
            dotnet add package mostlylucid.consoleimage --version ${{ needs.publish-core.outputs.version }}
            dotnet add package mostlylucid.consoleimage.video --version ${{ needs.publish-core.outputs.version }}
            dotnet add package mostlylucid.consoleimage.spectre --version ${{ needs.publish-core.outputs.version }}
            ```

            ### Features
            - **Four render modes**: ASCII art, Unicode color blocks, Braille patterns, Matrix rain
            - **Animated playback**: GIFs and videos with flicker-free DECSET 2026 sync
            - **Auto-fits to terminal**: Output defaults to your console size
            - **AOT compiled**: Fast startup, no .NET runtime required
            - **Cross-platform**: Windows, Linux, macOS (x64 and ARM64)

          files: |
            artifacts/**/*.zip
            artifacts/**/*.tar.gz
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================
  # Summary
  # ============================================
  summary:
    runs-on: ubuntu-latest
    needs: [publish-core, publish-video, publish-spectre, build-cli, release]
    if: always()
    steps:
    - name: Summary
      run: |
        VERSION="${{ needs.publish-core.outputs.version }}"
        echo "## Published Packages (v${VERSION})" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Package | Version | NuGet |" >> $GITHUB_STEP_SUMMARY
        echo "|---------|---------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| mostlylucid.consoleimage | ${VERSION} | [NuGet](https://www.nuget.org/packages/mostlylucid.consoleimage/${VERSION}) |" >> $GITHUB_STEP_SUMMARY
        echo "| mostlylucid.consoleimage.video | ${VERSION} | [NuGet](https://www.nuget.org/packages/mostlylucid.consoleimage.video/${VERSION}) |" >> $GITHUB_STEP_SUMMARY
        echo "| mostlylucid.consoleimage.spectre | ${VERSION} | [NuGet](https://www.nuget.org/packages/mostlylucid.consoleimage.spectre/${VERSION}) |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## CLI Releases" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| CLI | Platforms |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|-----------|" >> $GITHUB_STEP_SUMMARY
        echo "| consoleimage | win-x64, linux-x64, linux-arm64, osx-arm64 |" >> $GITHUB_STEP_SUMMARY
        echo "| consolevideo | win-x64, linux-x64, linux-arm64, osx-arm64 |" >> $GITHUB_STEP_SUMMARY
        echo "| consoleimage-mcp | win-x64, linux-x64, linux-arm64, osx-arm64 |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "[View Release](https://github.com/${{ github.repository }}/releases/tag/consoleimage-v${VERSION})" >> $GITHUB_STEP_SUMMARY
